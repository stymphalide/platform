module Platformer exposing (..)

import AnimationFrame exposing (diffs)
import Html exposing (Html, div)
import Keyboard exposing (KeyCode, downs)
import Random
import Svg exposing (..)
import Svg.Attributes exposing (..)
import Time exposing (Time)



-- MAIN
main : Program Never Model Msg
main =
    Html.program
    { init = init
    , view = view
    , update = update
    , subscriptions = subscriptions
    }

-- MODEL
type alias Model =
    { characterPositionX : Int
    , characterPositionY : Int
    , itemPositionX : Int
    , itemPositionY : Int
    }

initialModel : Model
initialModel =
    { characterPositionX = 50
    , characterPositionY = 300
    , itemPositionX = 500
    , itemPositionY = 300
    }


init : ( Model, Cmd Msg )
init =
    ( initialModel, Cmd.none )

-- UPDATE
type Msg
    = NoOp
    | KeyDown KeyCode
    | TimeUpdate Time

update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )
        KeyDown keyCode ->
            case keyCode of
                37 -> -- Left Arrow
                    ({model | characterPositionX = model.characterPositionX - 15}, Cmd.none)
                39 -> -- Right Arrow
                    ( {model | characterPositionX = model.characterPositionX + 15}, Cmd.none)
                _ ->
                    (model, Cmd.none)
        TimeUpdate time ->
            if characterFoundItem model then
                ( {model | itemPositionX = model.itemPositionX - 100}, Cmd.none)
            else
                (model, Cmd.none)

characterFoundItem : Model -> Bool
characterFoundItem model =
    let
        approximateItemLowerBound =
            model.itemPositionX - 35
        approximateItemUpperBound =
            model.itemPositionX + 35

        approximateItemRange =
            List.range approximateItemLowerBound approximateItemUpperBound
    in
        List.member model.characterPositionX approximateItemRange


-- SUBSCRIPTIONS
subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.batch 
    [ downs KeyDown
    , diffs TimeUpdate]

-- VIEW
view : Model -> Html Msg
view model =
    div [] 
        [ viewGame model]

viewGame : Model -> Svg Msg
viewGame model = 
    svg [ version "1.1", width "600", height "400" ] 
        [ viewGameWindow 
        , viewGameSky
        , viewGameGround
        , viewCharacter model
        , viewItem model
        ]


viewGameWindow : Svg Msg
viewGameWindow =
    rect
        [ width "600"
        , height "400"
        , fill "none"
        , stroke  "black"
        ] []


viewGameSky : Svg Msg
viewGameSky =
    rect
        [ x "0"
        , y "0"
        , width "600"
        , height "300"
        , fill "#4b7cfb"
        ] []

viewGameGround : Svg Msg
viewGameGround =
    rect 
        [ x "0"
        , y "300"
        , width "600"
        , height "100"
        , fill "green"
        ] []

viewCharacter : Model -> Svg Msg
viewCharacter model =
    image
        [ xlinkHref "/images/character.gif"
        , x <| toString model.characterPositionX
        , y <| toString model.characterPositionY
        , width "50"
        , height "50"
        ] []

viewItem : Model -> Svg Msg
viewItem model =
    image
        [ xlinkHref "/images/coin.svg"
        , x <| toString model.itemPositionX
        , y <| toString model.itemPositionY
        , width "20"
        , height "20"
        ] []

